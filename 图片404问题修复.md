# 图片404问题修复

## 🔍 问题分析

### 错误信息
```
GET http://127.0.0.1:3000/templates/images/14ee1759-6619-4152-a289-21387e9b7975.jpg 404 (Not Found)
GET http://127.0.0.1:3000/templates/images/xiaomi.png 404 (Not Found)
```

### 问题原因

**前端访问路径**: `http://127.0.0.1:3000/templates/images/xxx.jpg`
**后端实际路径**: `http://localhost:8080/templates/images/xxx.jpg`

**根本原因**:
- ✅ 图片路径处理正确（`/templates/images/xxx.jpg`）
- ❌ Vite开发服务器（端口3000）无法访问后端（端口8080）的静态资源
- ❌ Vite配置中缺少 `/templates` 路径的代理

---

## ✅ 修复方案

### 修改 `vite.config.js`

**文件**: `vite.config.js`

#### 修改前:
```javascript
server: {
  port: 3000,
  proxy: {
    '/api': {
      target: 'http://localhost:8080',
      changeOrigin: true
    },
    // ... 其他代理配置
    '/images': {
      target: 'http://localhost:8080',
      changeOrigin: true
    }
  }
}
```

#### 修改后:
```javascript
server: {
  port: 3000,
  proxy: {
    '/api': {
      target: 'http://localhost:8080',
      changeOrigin: true
    },
    // ... 其他代理配置
    '/images': {
      target: 'http://localhost:8080',
      changeOrigin: true
    },
    // ✅ 新增：代理templates目录下的静态资源
    '/templates': {
      target: 'http://localhost:8080',
      changeOrigin: true
    }
  }
}
```

---

## 🔧 应用修复

### ⚠️ 重要：必须重启开发服务器

Vite配置文件修改后，**必须重启开发服务器**才能生效！

### 重启步骤

1. **停止当前开发服务器**
   - 在运行 `npm run dev` 的终端按 `Ctrl+C`

2. **重新启动开发服务器**
   ```bash
   npm run dev
   ```

3. **刷新浏览器**
   - 按 `Ctrl+F5` 强制刷新页面

---

## 📊 代理工作原理

### 请求流程

```
浏览器请求
  ↓
http://127.0.0.1:3000/templates/images/xxx.jpg
  ↓
Vite代理检测到 /templates 前缀
  ↓
转发到后端
  ↓
http://localhost:8080/templates/images/xxx.jpg
  ↓
后端返回图片
  ↓
Vite转发给浏览器
  ↓
图片显示成功 ✅
```

### 代理配置说明

| 前端请求路径 | 代理配置 | 后端实际路径 |
|------------|---------|------------|
| `/api/products` | `/api` → `http://localhost:8080` | `http://localhost:8080/api/products` |
| `/templates/images/1.jpg` | `/templates` → `http://localhost:8080` | `http://localhost:8080/templates/images/1.jpg` |
| `/images/1.jpg` | `/images` → `http://localhost:8080` | `http://localhost:8080/images/1.jpg` |

---

## 🧪 测试步骤

### 测试1: 检查代理配置

1. 停止开发服务器（`Ctrl+C`）
2. 重新启动：`npm run dev`
3. 查看终端输出，确认服务器启动成功

**预期输出**:
```
VITE v5.x.x  ready in xxx ms

➜  Local:   http://127.0.0.1:3000/
➜  Network: use --host to expose
➜  press h + enter to show help
```

---

### 测试2: 访问商家后台

1. 打开浏览器访问: `http://127.0.0.1:3000/merchant-login`
2. 登录商家账号
3. 进入商品管理页面

**预期结果**:
- ✅ 商品列表正常显示
- ✅ 商品图片正常加载
- ✅ 浏览器控制台无404错误

---

### 测试3: 检查网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 **Network（网络）** 标签
3. 刷新商品管理页面
4. 查看图片请求

**预期结果**:
```
Request URL: http://127.0.0.1:3000/templates/images/xxx.jpg
Status Code: 200 OK
Content-Type: image/jpeg
```

---

## 🎯 完整的图片访问流程

### 1. 后端返回商品数据

```json
{
  "success": true,
  "records": [
    {
      "productId": 1,
      "productName": "小米手机",
      "productImagePath": "images/xiaomi.png",
      "productPrice": 2999
    }
  ]
}
```

### 2. 前端处理图片路径

**MerchantDashboard.vue**:
```javascript
const productList = data.records.map(record => ({
  id: record.productId,
  productName: record.productName,
  imagePath: record.productImagePath || '',  // "images/xiaomi.png"
  // ...
}))

products.value = processProductImages(productList)
```

**imageHelper.js**:
```javascript
export function getImageUrl(imagePath) {
  // imagePath = "images/xiaomi.png"
  
  if (imagePath.startsWith('images/')) {
    return `/templates/${imagePath}`  // "/templates/images/xiaomi.png"
  }
  
  // ...
}
```

### 3. 渲染图片标签

```html
<img src="/templates/images/xiaomi.png" alt="小米手机" />
```

### 4. 浏览器发起请求

```
GET http://127.0.0.1:3000/templates/images/xiaomi.png
```

### 5. Vite代理转发

```javascript
// vite.config.js
'/templates': {
  target: 'http://localhost:8080',
  changeOrigin: true
}
```

转发到:
```
GET http://localhost:8080/templates/images/xiaomi.png
```

### 6. 后端返回图片

Spring Boot静态资源配置返回图片文件

### 7. 图片显示成功 ✅

---

## 🔍 故障排查

### 如果图片仍然404

#### 检查1: 确认后端图片存在

在浏览器直接访问后端地址：
```
http://localhost:8080/templates/images/xiaomi.png
```

**如果404**: 后端图片文件不存在或路径配置错误
**如果200**: 后端正常，问题在前端代理

---

#### 检查2: 确认代理配置生效

1. 查看 `vite.config.js` 是否包含 `/templates` 代理
2. 确认已重启开发服务器
3. 查看浏览器Network标签，检查请求是否被代理

---

#### 检查3: 检查后端静态资源配置

**Spring Boot配置** (通常在 `application.properties` 或 `application.yml`):

```properties
# 静态资源路径配置
spring.web.resources.static-locations=classpath:/static/,classpath:/templates/,file:./uploads/
```

或者在代码中配置:
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/templates/**")
                .addResourceLocations("classpath:/templates/");
        registry.addResourceHandler("/images/**")
                .addResourceLocations("classpath:/static/images/");
    }
}
```

---

## ✅ 验收标准

- [x] Vite配置添加 `/templates` 代理
- [ ] 重启开发服务器
- [ ] 商品图片正常显示
- [ ] 浏览器控制台无404错误
- [ ] Network标签显示图片请求200 OK

---

## 📝 重要提醒

### ⚠️ 必须重启开发服务器

修改 `vite.config.js` 后，**必须重启开发服务器**！

### 重启命令

```bash
# 1. 停止当前服务器（在运行npm run dev的终端）
Ctrl+C

# 2. 重新启动
npm run dev
```

### 刷新浏览器

```
Ctrl+F5  (强制刷新，清除缓存)
```

---

**修复完成时间**: 2025-10-15
**修复状态**: ✅ 配置已修改
**下一步**: ⚠️ **请重启开发服务器并刷新浏览器测试！**

---

## 🚀 快速修复步骤

1. ✅ **已完成**: 修改 `vite.config.js`，添加 `/templates` 代理
2. ⏳ **待执行**: 停止开发服务器（`Ctrl+C`）
3. ⏳ **待执行**: 重新启动（`npm run dev`）
4. ⏳ **待执行**: 刷新浏览器（`Ctrl+F5`）
5. ⏳ **待执行**: 检查图片是否正常显示

**请按照上述步骤操作，图片应该就能正常显示了！** 🖼️

