<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>优品商城 - 正品低价、品质保障、配送及时、轻松购物！</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    /* 顶部导航 */
    .site-nav {
      background-color: #f2f2f2;
      border-bottom: 1px solid #e5e5e5;
      font-size: 12px;
      color: #666;
    }

    .site-nav .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 35px;
    }

    .nav-left a,
    .nav-right a {
      margin-left: 15px;
      color: #666;
      text-decoration: none;
    }

    .nav-left a:hover,
    .nav-right a:hover {
      color: #ff0036;
    }

    /* 头部搜索区 */
    .header {
      background-color: #fff;
      padding: 20px 0;
    }

    .header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo h1 {
      color: #ff0036;
      font-size: 30px;
      font-weight: bold;
    }

    .search-box {
      width: 550px;
    }

    .search-input {
      display: flex;
      border: 2px solid #ff0036;
      border-radius: 4px;
      overflow: hidden;
    }

    .search-input input {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
      font-size: 14px;
    }

    .search-btn {
      width: 90px;
      background-color: #ff0036;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }

    .cart-box {
      display: flex;
      align-items: center;
      padding: 8px 15px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      cursor: pointer;
    }

    .cart-box:hover {
      border-color: #ff0036;
    }

    /* 主导航 */
    .main-nav {
      background-color: #ff0036;
      margin-bottom: 20px;
    }

    .main-nav .container {
      display: flex;
      height: 40px;
    }

    .nav-links {
      display: flex;
      align-items: center;
      padding-left: 30px;
    }

    .nav-links a {
      color: white;
      margin-right: 30px;
      font-size: 16px;
      text-decoration: none;
    }

    /* 商品展示区 */
    .featured-section {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e5e5;
    }

    .section-header h2 {
      font-size: 22px;
      color: #333;
    }

    .more {
      color: #666;
      font-size: 14px;
      text-decoration: none;
    }

    .product-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: -10px;
    }

    .product-card {
      flex: 0 0 calc(25% - 20px);
      margin: 10px;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      min-width: 200px;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .product-image {
      position: relative;
      height: 200px;
      overflow: hidden;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .product-card:hover .product-image img {
      transform: scale(1.1);
    }

    .product-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #ff0036;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .product-badge.hot {
      background-color: #ff6b00;
    }

    .product-info {
      padding: 15px;
    }

    .product-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
      height: 44px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .product-desc {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
      height: 40px;
      overflow: hidden;
    }

    .product-price {
      display: flex;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .price-now {
      color: #ff0036;
      font-size: 20px;
      font-weight: bold;
    }

    .price-original {
      color: #999;
      font-size: 14px;
      text-decoration: line-through;
      margin-left: 8px;
    }

    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }

    .sales {
      color: #999;
      font-size: 12px;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      font-size: 12px;
      color: #666;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 4px;
      transition: all 0.3s;
    }

    .action-btn:hover {
      background-color: #f5f5f5;
    }

    .action-btn i {
      margin-right: 5px;
      color: #666;
      transition: color 0.3s;
    }

    .favorite-btn.active {
      color: #ff0036;
    }

    .favorite-btn.active i {
      color: #ff0036;
    }

    .action-btn:hover i {
      color: #ff0036;
    }

    /* 响应式设计 */
    @media (max-width: 1024px) {
      .container {
        padding: 0 10px;
      }

      .search-box {
        width: 400px;
      }

      .product-card {
        flex: 0 0 calc(33.333% - 20px);
      }
    }

    @media (max-width: 768px) {
      .nav-right {
        display: none;
      }

      .search-box {
        width: 300px;
      }

      .product-card {
        flex: 0 0 calc(50% - 20px);
      }
    }

    @media (max-width: 480px) {
      .nav-left {
        display: none;
      }

      .search-box {
        width: 200px;
      }

      .product-card {
        flex: 0 0 100%;
        margin: 10px 0;
      }
    }

    /* 错误提示样式 */
    .error-message {
      text-align: center;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin: 20px auto;
      max-width: 500px;
    }

    .error-message p {
      margin: 10px 0;
      color: #666;
    }

    .error-message button {
      background-color: #ff0036;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .error-message button:hover {
      background-color: #cc002b;
    }

    .no-products {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 16px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
<!-- 顶部导航 -->
<div class="site-nav">
  <div class="container">
    <div class="nav-left">
      <span class="welcome">欢迎来到优品商城！</span>
      <span id="loginStatus">
        <a href="login.html" id="loginLink"><i class="fas fa-user"></i> 请登录</a>
        <span id="userInfo" style="display: none;">
          <i class="fas fa-user"></i> <span id="username"></span>
          <a href="#" id="logoutLink" style="margin-left: 10px; color: #666;"><i class="fas fa-sign-out-alt"></i> 退出</a>
        </span>
      </span>
    </div>
    <div class="nav-right">
      <a href="records.html" id="myOrders"><i class="fas fa-list"></i> 我的订单</a>
      <a href="cart.html" id="cartLink"><i class="fas fa-shopping-cart"></i> 购物车</a>
      <a href="favorites.html" id="favoritesLink"><i class="fas fa-star"></i> 收藏夹</a>
<!--      <a href="#"><i class="fas fa-mobile-alt"></i> 手机版</a>-->
      <a href="help.html"><i class="fas fa-question-circle"></i> 帮助中心</a>
    </div>
  </div>
</div>

<!-- 头部搜索区 -->
<div class="header">
  <div class="container">
    <div class="logo">
      <h1>优品商城</h1>
    </div>
    <div class="search-box">
      <div class="search-input">
        <label for="searchInput" class="sr-only">搜索商品</label>
        <input type="text"
               id="searchInput"
               name="searchInput"
               placeholder="请输入要搜索的商品"
               aria-label="搜索商品"
               title="搜索商品">
        <button class="search-btn"
                type="button"
                onclick="submitSearch()"
                aria-label="搜索"
                title="搜索">
          搜索
        </button>
      </div>
    </div>
<!--    <div class="cart-box">-->
<!--      <i class="fas fa-shopping-cart"></i>-->
<!--      <span>购物车</span>-->
<!--    </div>-->
  </div>
</div>

<!-- 主导航 -->
<div class="main-nav">
  <div class="container">
    <nav class="nav-links">
      <a href="#" onclick="getAllProducts()"  class="active">首页</a>
      <a href="#" onclick="searchByStatus('秒杀')">秒杀</a>
      <a href="#" onclick="searchByStatus('特惠')">特惠</a>
      <a href="#" onclick="searchByStatus('新品')">新品</a>
      <a href="#" onclick="searchByStatus('热销')">热销</a>
      <a href="#" onclick="searchByStatus('品牌')">品牌</a>
    </nav>
  </div>
</div>

<!-- 商品展示区 -->
<div class="container">
  <div class="featured-section">
    <div class="section-header">
      <h2>特色商品</h2>
      <a href="#" class="more">查看更多 <i class="fas fa-angle-right"></i></a>
    </div>
    <div class="product-grid" id="productGrid">
      <!-- 商品卡片将通过JavaScript动态添加 -->
    </div>
  </div>
</div>

<script>
  // 在 script 标签开始处添加全局变量
  let favoriteItems = [];  // 存储收藏的商品
  let currentTab = 'all';  // 当前选中的标签，默认为 'all'

  // 在 script 标签开始处添加错误处理函数
  function handleError(error, message) {
    console.error(message, error);
    const favoritesGrid = document.getElementById('favoritesGrid');
    if (favoritesGrid) {
      favoritesGrid.innerHTML = `
        <div class="error-message">
          <p>${message}</p>
          <button onclick="fetchFavoriteItems()">重试</button>
        </div>
      `;
    }
  }

  // 修改渲染函数
  function renderFavorites() {
    const favoritesGrid = document.getElementById('favoritesGrid');
    if (!favoritesGrid) {
      console.error('找不到 favoritesGrid 元素');
      return;
    }

    if (!favoriteItems || favoriteItems.length === 0) {
      favoritesGrid.innerHTML = '<div class="no-products">暂无收藏商品</div>';
      return;
    }

    try {
      // 显示商品总数
      const totalCount = document.getElementById('totalCount');
      if (totalCount) {
        totalCount.textContent = `共 ${favoriteItems.length} 件商品`;
      }

      favoritesGrid.innerHTML = favoriteItems.map(item => {
        return `
          <div class="product-card">
            <input type="checkbox" class="item-checkbox" ${item.isSelected ? 'checked' : ''}
                   onchange="toggleSelect(${item.id})" style="display: none;">
            <div class="product-image">
              <img src="${item.imagePath}" alt="${item.productName}">
              ${item.status === 'sale' ? '<span class="product-badge">促销</span>' : ''}
            </div>
            <div class="product-info">
              <div class="product-name">${item.productName}</div>
              <div class="product-desc">${item.productDesc}</div>
              <div class="product-price">
                <span class="price-now">¥${item.nowPrice}</span>
                <span class="price-original">¥${item.originalPrice}</span>
              </div>
              <div class="product-footer">
                <span class="sales">已售${item.salesCount}件</span>
                <div class="actions">
                  <span class="action-btn favorite-btn active" onclick="toggleFavorite(${item.id})">
                    <i class="fas fa-heart"></i>取消收藏
                  </span>
                  <span class="action-btn" onclick="addToCart(${item.id})">
                    <i class="fas fa-shopping-cart"></i>加入购物车
                  </span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    } catch (error) {
      handleError(error, '渲染收藏商品时出错');
    }
  }

  // 添加事件处理函数
  async function toggleSelect(itemId) {
    try {
      const item = favoriteItems.find(item => item.id === itemId);
      if (item) {
        item.isSelected = !item.isSelected;
        renderFavorites();
      }
    } catch (error) {
      handleError(error, '切换选择状态时出错');
    }
  }

  async function toggleFavorite(productId) {
    try {
      const userId = localStorage.getItem('userId');
      if (!userId) {
        alert('请先登录');
        return;
      }

      const response = await fetch(`http://localhost:8080/user-favorites/${userId}/${productId}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        throw new Error('取消收藏失败');
      }

      // 从列表中移除商品
      favoriteItems = favoriteItems.filter(item => item.id !== productId);
      renderFavorites();
      alert('已取消收藏');
    } catch (error) {
      console.error('取消收藏失败:', error);
      alert('取消收藏失败，请稍后重试');
    }
  }

  async function addToCart(itemId) {
    try {
      const userId = localStorage.getItem('userId');
      if (!userId) {
        alert('请先登录');
        return;
      }

      const response = await fetch('http://localhost:8080/api/cart/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: userId,
          productId: itemId,
          quantity: 1
        })
      });

      if (!response.ok) {
        throw new Error('加入购物车失败');
      }

      alert('已加入购物车');
    } catch (error) {
      handleError(error, '加入购物车时出错');
    }
  }

  // 修改获取收藏商品的函数
  async function fetchFavoriteItems() {
    try {
      const userId = localStorage.getItem('userId');
      console.log('当前用户ID:', userId);

      if (!userId) {
        const favoritesGrid = document.getElementById('favoritesGrid');
        if (favoritesGrid) {
          favoritesGrid.innerHTML = '<div class="no-products">请先登录</div>';
        }
        return;
      }

      const response = await fetch(`http://localhost:8080/user-favorites/${userId}`);
      console.log('后端响应状态:', response.status);

      if (!response.ok) {
        throw new Error('获取收藏商品失败');
      }

      const result = await response.json();
      console.log('后端返回的原始数据:', result);

      // 检查响应格式
      if (result.code === 200) {
        // 使用 result.data 而不是直接使用 result
        favoriteItems = result.data.map(item => ({
          id: item.id,
          productName: item.productName,
          productDesc: item.productDesc,
          nowPrice: item.nowPrice,
          originalPrice: item.originalPrice,
          salesCount: item.salesCount,
          imagePath: item.imagePath,
          status: item.status,
          category: item.category,
          brand: item.brand,
          createTime: item.createTime,
          shippingAddress: item.shippingAddress,
          isSelected: false
        }));

        console.log('处理后的数据:', favoriteItems);
        renderFavorites();
      } else {
        throw new Error(result.message || '获取收藏商品失败');
      }
    } catch (error) {
      console.error('获取收藏商品数据失败:', error);
      handleError(error, '获取收藏商品数据失败');
    }
  }

  // 检查登录状态
  function checkLoginStatus() {
    const username = localStorage.getItem('username');
    const loginLink = document.getElementById('loginLink');
    const userInfo = document.getElementById('userInfo');
    const usernameSpan = document.getElementById('username');
    const logoutLink = document.getElementById('logoutLink');

    if (username) {
      loginLink.style.display = 'none';
      userInfo.style.display = 'inline';
      usernameSpan.textContent = username;

      // 添加退出登录事件
      logoutLink.addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('username');
        // 更新页面显示，而不是跳转
        loginLink.style.display = 'inline';
        userInfo.style.display = 'none';
      });
    } else {
      loginLink.style.display = 'inline';
      userInfo.style.display = 'none';
    }
  }

  // 页面加载时检查登录状态
  window.onload = function() {
    checkLoginStatus();
    getAllProducts();
    fetchFavoriteItems();
  };

  // 调用后端接口获取所有商品
  async function getAllProducts() {
    try {
      const response = await fetch('http://localhost:8080/api/all-products', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify('')  // 发送空字符串
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const products = await response.json();
      const productGrid = document.getElementById('productGrid');

      products.forEach(product => {
        const card = document.createElement('div');
        card.classList.add('product-card');
        card.innerHTML = `
            <div class="product-image">
                <img src="${product.imagePath}" alt="${product.productName}">
            </div>
            <div class="product-info">
                <div class="product-name">${product.productName}</div>
                <div class="product-price">
                    <span class="price-now">¥${product.nowPrice}</span>
                    <span class="price-original">¥${product.originalPrice}</span>
                </div>
                <div class="product-footer">
                    <span class="sales">已售${product.salesCount}件</span>
                    <div class="actions">
                        <span class="action-btn favorite-btn" onclick="event.stopPropagation(); toggleFavorite(${product.id})">
                            <i class="fas fa-heart"></i>收藏
                        </span>
                        <span class="action-btn" onclick="event.stopPropagation(); addToCart(${product.id})">
                            <i class="fas fa-shopping-cart"></i>加入购物车
                        </span>
                    </div>
                </div>
            </div>
          `;

        // 添加点击事件，跳转到商品详情页面
        card.addEventListener('click', () => {
          window.location.href = `product-detail.html?id=${product.id}`;
        });
        productGrid.appendChild(card);

        // 检查并更新收藏状态
        checkFavoriteStatus(product.id).then(isFavorite => {
          const favoriteBtn = card.querySelector('.favorite-btn');
          if (favoriteBtn && isFavorite) {
            favoriteBtn.classList.add('active');
            favoriteBtn.innerHTML = `<i class="fas fa-heart"></i>取消收藏`;
          }
        });
      });
    } catch (error) {
      console.error('请求出错:', error);
      alert('获取商品列表出现错误，请稍后重试');
    }
  }

  // 秒杀/特惠/新品/热销/品牌商品
  async function searchByStatus(status) {
    try {
      console.log('即将发送给后端的状态数据:', status);

      const response = await fetch('http://localhost:8080/api/searchByStatus', {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain'
        },
        body: status
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const products = await response.json();
      const productGrid = document.getElementById('productGrid');
      productGrid.innerHTML = ''; // 清空原有商品

      products.forEach(product => {
        const card = document.createElement('div');
        card.classList.add('product-card');
        card.innerHTML = `
                <div class="product-image">
                    <img src="${product.imagePath}" alt="${product.productName}">
                </div>
                <div class="product-info">
                    <div class="product-name">${product.productName}</div>
                    <div class="product-price">
                        <span class="price-now">¥${product.nowPrice}</span>
                        <span class="price-original">¥${product.originalPrice}</span>
                    </div>
                    <div class="product-footer">
                        <span class="sales">已售${product.salesCount}件</span>
                        <div class="actions">
                            <span class="action-btn favorite-btn" onclick="event.stopPropagation(); toggleFavorite(${product.id})">
                                <i class="fas fa-heart"></i>收藏
                            </span>
                            <span class="action-btn" onclick="event.stopPropagation(); addToCart(${product.id})">
                                <i class="fas fa-shopping-cart"></i>加入购物车
                            </span>
                        </div>
                    </div>
                </div>
            `;

        // 添加点击事件，跳转到商品详情页面
        card.addEventListener('click', () => {
          window.location.href = `product-detail.html?id=${product.id}`;
        });
        productGrid.appendChild(card);

        // 检查并更新收藏状态
        checkFavoriteStatus(product.id).then(isFavorite => {
          const favoriteBtn = card.querySelector('.favorite-btn');
          if (favoriteBtn && isFavorite) {
            favoriteBtn.classList.add('active');
            favoriteBtn.innerHTML = `<i class="fas fa-heart"></i>取消收藏`;
          }
        });
      });
    } catch (error) {
      console.error('请求出错:', error);
      alert('获取商品列表出现错误，请稍后重试');
    }
  }

  // 搜索功能
  function submitSearch() {
    const input = document.getElementById('searchInput');
    const searchValue = input.value;
    window.location.href = `search-results.html?q=${encodeURIComponent(searchValue)}`;
  }

  // 检查商品是否已收藏
  async function checkFavoriteStatus(productId) {
    try {
      const userName = localStorage.getItem('username');
      if (!userName) return false;

      const response = await fetch(`http://localhost:8080/user-favorites/${userName}/${productId}`);
      if (!response.ok) return false;

      const result = await response.json();
      return result === true;
    } catch (error) {
      console.error('检查收藏状态失败:', error);
      return false;
    }
  }

  // 更新商品卡片的收藏状态
  async function updateFavoriteStatus(productId, element) {
    const isFavorite = await checkFavoriteStatus(productId);
    const favoriteBtn = element.querySelector('.favorite-btn');
    if (favoriteBtn) {
      favoriteBtn.classList.toggle('active', isFavorite);
      favoriteBtn.innerHTML = `<i class="fas fa-heart"></i>${isFavorite ? '取消收藏' : '收藏'}`;
    }
  }

  // 切换收藏状态
  async function toggleFavorite(productId) {
    const userName = localStorage.getItem('username');
    if (!userName) {
      alert('请先登录');
      return;
    }

    try {
      // 检查当前收藏状态
      const isFavorite = await checkFavoriteStatus(productId);

      let url, method, data;
      if (isFavorite) {
        // 取消收藏
        url = `http://localhost:8080/user-favorites/${userName}/${productId}`;
        method = 'DELETE';
      } else {
        // 添加收藏
        url = 'http://localhost:8080/user-favorites/add';
        method = 'POST';
        data = {
          userName: userName,
          productId: productId
        };
      }

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: data ? JSON.stringify(data) : null
      });

      if (!response.ok) {
        throw new Error('操作收藏失败');
      }

      // 更新按钮状态
      const favoriteBtn = document.querySelector(`.favorite-btn[onclick="event.stopPropagation(); toggleFavorite(${productId})"]`);
      if (favoriteBtn) {
        favoriteBtn.classList.toggle('active', !isFavorite);
        favoriteBtn.innerHTML = `<i class="fas fa-heart"></i>${!isFavorite ? '取消收藏' : '收藏'}`;
      }

      alert(isFavorite ? '已取消收藏' : '已加入收藏');
    } catch (error) {
      console.error('操作收藏失败:', error);
      alert('操作收藏失败，请稍后重试');
    }
  }

  // 加入购物车功能
  async function addToCart(productId) {
    const userName = localStorage.getItem('username');
    if (!userName) {
      alert('请先登录');
      return;
    }

    try {
      const response = await fetch('http://localhost:8080/cart/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userName: userName,
          productId: productId
        })
      });

      if (!response.ok) {
        throw new Error('加入购物车失败');
      }

      alert('已加入购物车');
    } catch (error) {
      console.error('加入购物车失败:', error);
      alert('加入购物车失败，请稍后重试');
    }
  }
</script>
</body>
</html>