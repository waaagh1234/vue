<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商家管理后台 - 优品商城</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 自动完成列表样式 */
        .autocomplete-list {
            position: absolute;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            display: none;
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .autocomplete-item:hover {
            background-color: #f5f5f5;
        }

        .form-group {
            position: relative;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: #fff;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #3d5165;
        }

        .sidebar-header h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 14px;
            color: #bdc3c7;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item:hover, .menu-item.active {
            background-color: #34495e;
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* 主内容区样式 */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .btn i {
            margin-right: 5px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        /* 商品列表样式 */
        .products-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
        }

        .products-table th, .products-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .products-table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }

        .products-table tr:hover {
            background-color: #f5f5f5;
        }

        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            object-fit: cover;
        }

        .product-actions {
            display: flex;
            gap: 5px;
        }

        .action-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-icon {
            background-color: #3498db;
            color: white;
        }

        .edit-icon:hover {
            background-color: #2980b9;
        }

        .delete-icon {
            background-color: #e74c3c;
            color: white;
        }

        .delete-icon:hover {
            background-color: #c0392b;
        }

        .view-icon {
            background-color: #2ecc71;
            color: white;
        }

        .view-icon:hover {
            background-color: #27ae60;
        }

        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            margin: 0 5px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination-btn:hover, .pagination-btn.active {
            background: #3498db;
            color: #fff;
            border-color: #3498db;
        }

        /* 添加商品表单样式 */
        .add-product-form {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .form-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
            padding: 0 10px;
            margin-bottom: 20px;
        }

        .form-group.full-width {
            flex: 0 0 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* 图片上传预览 */
        .image-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-preview-placeholder {
            color: #999;
            text-align: center;
        }

        .image-preview-placeholder i {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* 状态标签 */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background-color: #e8f7ef;
            color: #27ae60;
        }

        .status-inactive {
            background-color: #fdeaea;
            color: #e74c3c;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }

            .main-content {
                margin-left: 0;
            }

            .products-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>商家管理后台</h2>
                <p>当前用户: <span id="currentMerchant">优品商城</span></p>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active">
                    <i class="fas fa-box"></i>
                    <span>商品管理</span>
                </div>
                <div class="menu-item" onclick="window.location.href='merchant-orders.html'">
                    <i class="fas fa-shopping-cart"></i>
                    <span>订单管理</span>
                </div>
                <div class="menu-item" onclick="window.location.href='merchant-statistics.html'">
                    <i class="fas fa-chart-bar"></i>
                    <span>销售统计</span>
                </div>
                <div class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span>账户设置</span>
                </div>
                <div class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>退出登录</span>
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <div class="page-header">
                <h1 class="page-title">商品管理</h1>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="toggleAddProductForm">
                        <i class="fas fa-plus"></i> 添加商品
                    </button>
                    <button class="btn btn-success">
                        <i class="fas fa-file-export"></i> 导出数据
                    </button>
                </div>
            </div>

            <!-- 添加商品表单 -->
            <div class="add-product-form" id="addProductForm">
                <h2 class="form-title">添加新商品</h2>
                <form id="productForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productName">商品名称 <span style="color: red;">*</span></label>
                            <input type="text" id="productName" name="productName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="brand">品牌</label>
                            <input type="text" id="brand" name="brand" class="form-control">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nowPrice">现价 <span style="color: red;">*</span></label>
                            <input type="number" id="nowPrice" name="nowPrice" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="originalPrice">原价 <span style="color: red;">*</span></label>
                            <input type="number" id="originalPrice" name="originalPrice" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="category">分类</label>
                            <input type="text" id="category" name="category" class="form-control" placeholder="请输入商品分类">
                            <div id="categoryAutocomplete" class="autocomplete-list"></div>
                            <small class="form-text text-muted">例如：电子产品、服装、食品、家居、美妆、图书等</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">状态</label>
                            <select id="status" name="status" class="form-control">
                                <option value="在售">在售</option>
                                <option value="下架">下架</option>
                                <option value="缺货">缺货</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="shippingAddress">发货地址</label>
                            <input type="text" id="shippingAddress" name="shippingAddress" class="form-control">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="productDesc">商品描述</label>
                        <textarea id="productDesc" name="productDesc" class="form-control"></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label for="productImage" id="imageLabel">商品图片 <span style="color: red;">*</span></label>
                        <input type="file" id="productImage" name="productImage" class="form-control" accept="image/*">
                        <small id="imageHelp" class="form-text text-muted">添加商品时必选，编辑商品时可选。如果不选择新图片，将保留原有图片。</small>
                        <div class="image-preview" id="imagePreview">
                            <div class="image-preview-placeholder">
                                <i class="fas fa-image"></i>
                                <p>选择图片预览</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="cancelAddProduct">取消</button>
                        <button type="submit" class="btn btn-success">保存商品</button>
                    </div>
                </form>
            </div>

            <!-- 商品列表 -->
            <div class="products-container">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>图片</th>
                            <th>商品名称</th>
                            <th>价格</th>
                            <th>分类</th>
                            <th>销量</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- 商品数据将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            <div class="pagination" id="pagination">
                <!-- 分页将通过JavaScript动态添加 -->
            </div>
        </div>
    </div>

    <script>
        // 检查商家登录状态
        function checkMerchantLogin() {
            const merchantLoggedIn = localStorage.getItem('merchantLoggedIn');
            const merchantName = localStorage.getItem('merchantName');

            if (!merchantLoggedIn || merchantLoggedIn !== 'true') {
                // 未登录，跳转到登录页面
                window.location.href = 'merchant-login.html';
                return false;
            }

            // 不再在这里更新商家名称，避免DOM还未加载完成
            return true;
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('merchantId');
            localStorage.removeItem('merchantName');
            localStorage.removeItem('merchantLoggedIn');
            window.location.href = 'merchant-login.html';
        }

        // 重置图片预览
        function resetImagePreview() {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.innerHTML = `
                <div class="image-preview-placeholder">
                    <i class="fas fa-image"></i>
                    <p>选择图片预览</p>
                </div>
            `;
        }

        // 验证表单
        function validateForm() {
            const productName = document.getElementById('productName').value;
            const nowPrice = document.getElementById('nowPrice').value;
            const originalPrice = document.getElementById('originalPrice').value;
            const productImage = document.getElementById('productImage').files[0];
            const productId = document.getElementById('productId');

            if (!productName) {
                alert('请输入商品名称');
                return false;
            }

            if (!nowPrice) {
                alert('请输入现价');
                return false;
            }

            if (!originalPrice) {
                alert('请输入原价');
                return false;
            }

            // 如果是添加商品（没有productId），则验证图片
            // 如果是编辑商品（有productId），则不强制验证图片
            if (!productId && !productImage) {
                alert('请选择商品图片');
                return false;
            }

            // 如果是编辑模式，更新按钮文本
            const submitButton = document.querySelector('button[type="submit"]');
            if (productId) {
                submitButton.textContent = '更新商品';
                // 移除图片必选标记
                document.getElementById('imageLabel').innerHTML = '商品图片';
            } else {
                submitButton.textContent = '保存商品';
                // 添加图片必选标记
                document.getElementById('imageLabel').innerHTML = '商品图片 <span style="color: red;">*</span>';
            }

            return true;
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            if (!checkMerchantLogin()) {
                return;
            }

            // 显示当前用户名
            const username = localStorage.getItem('merchantName');
            if (!username) {
                console.error('未找到商家用户名，请先登录');
                alert('请先登录');
                window.location.href = 'merchant-login.html';
                return;
            }

            // 在页面完全加载后更新用户名显示
            setTimeout(() => {
                try {
                    const currentMerchantElement = document.getElementById('currentMerchant');
                    if (currentMerchantElement) {
                        currentMerchantElement.textContent = username;
                        console.log('用户名显示更新成功:', username);
                    } else {
                        console.warn('未找到显示用户名的元素');
                    }
                } catch (error) {
                    console.error('更新用户名显示时出错:', error);
                }
            }, 100); // 等待100毫秒确保DOM已加载
            // 获取元素
            const toggleAddProductFormBtn = document.getElementById('toggleAddProductForm');
            const addProductForm = document.getElementById('addProductForm');
            const cancelAddProductBtn = document.getElementById('cancelAddProduct');
            const productForm = document.getElementById('productForm');
            const productImage = document.getElementById('productImage');
            const imagePreview = document.getElementById('imagePreview');

            // 显示/隐藏添加商品表单
            toggleAddProductFormBtn.addEventListener('click', function() {
                addProductForm.style.display = addProductForm.style.display === 'none' || addProductForm.style.display === '' ? 'block' : 'none';
            });

            // 取消添加商品
            cancelAddProductBtn.addEventListener('click', function() {
                addProductForm.style.display = 'none';
                productForm.reset();

                // 直接重置图片预览，而不是调用resetImagePreview函数
                imagePreview.innerHTML = `
                    <div class="image-preview-placeholder">
                        <i class="fas fa-image"></i>
                        <p>选择图片预览</p>
                    </div>
                `;
            });

            // 图片预览
            productImage.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.innerHTML = `<img src="${e.target.result}" alt="商品图片预览">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    // 直接重置图片预览，而不是调用resetImagePreview函数
                    imagePreview.innerHTML = `
                        <div class="image-preview-placeholder">
                            <i class="fas fa-image"></i>
                            <p>选择图片预览</p>
                        </div>
                    `;
                }
            });

            // 使用全局的resetImagePreview函数

            // 提交表单
            productForm.addEventListener('submit', addProductSubmit);

            // 添加商品的提交函数
            async function addProductSubmit(event) {
                event.preventDefault();

                // 验证表单
                if (!validateForm()) {
                    return;
                }

                // 获取表单数据
                const formData = new FormData();
                formData.append('productName', document.getElementById('productName').value);
                formData.append('productDesc', document.getElementById('productDesc').value);
                formData.append('nowPrice', document.getElementById('nowPrice').value);
                formData.append('originalPrice', document.getElementById('originalPrice').value);
                formData.append('brand', document.getElementById('brand').value);
                formData.append('category', document.getElementById('category').value);
                formData.append('status', document.getElementById('status').value);
                formData.append('shippingAddress', document.getElementById('shippingAddress').value);
                formData.append('image', document.getElementById('productImage').files[0]);

                // 获取商家用户名并添加到表单数据中
                const merchantName = localStorage.getItem('merchantName');
                if (merchantName) {
                    formData.append('userName', merchantName);
                    console.log('添加商家用户名到表单:', merchantName);
                } else {
                    console.warn('未找到商家用户名');
                }

                try {
                    // 发送请求
                    const response = await fetch('http://localhost:8080/api/products/add', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('添加商品失败');
                    }

                    const result = await response.json();

                    if (result.success) {
                        // 商品添加成功，商家记录已在后端创建
                        console.log('商品添加成功，ID:', result.product.id);
                        console.log('商品详情:', result.product);

                        alert('商品添加成功！');
                        addProductForm.style.display = 'none';
                        productForm.reset();
                        resetImagePreview();
                        window.fetchMerchantProducts(); // 重新获取商家商品列表
                    } else {
                        alert('添加商品失败：' + result.message);
                    }
                } catch (error) {
                    console.error('添加商品出错:', error);
                    alert('添加商品失败，请稍后重试');
                }
            }

            // 使用全局的validateForm函数

            // 更新商品的提交函数
            async function updateProductSubmit(event) {
                event.preventDefault();

                // 验证表单
                if (!validateForm()) {
                    return;
                }

                // 获取商品ID
                const productId = document.getElementById('productId').value;

                // 获取表单数据
                const formData = new FormData();
                formData.append('productName', document.getElementById('productName').value);
                formData.append('productDesc', document.getElementById('productDesc').value);
                formData.append('nowPrice', document.getElementById('nowPrice').value);
                formData.append('originalPrice', document.getElementById('originalPrice').value);
                formData.append('brand', document.getElementById('brand').value);
                formData.append('category', document.getElementById('category').value);
                formData.append('status', document.getElementById('status').value);
                formData.append('shippingAddress', document.getElementById('shippingAddress').value);

                // 如果选择了新图片，则添加到表单数据中
                const productImage = document.getElementById('productImage');
                if (productImage.files.length > 0) {
                    formData.append('image', productImage.files[0]);
                }

                try {
                    // 发送请求
                    const response = await fetch(`http://localhost:8080/api/products/${productId}`, {
                        method: 'PUT',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('更新商品失败');
                    }

                    const result = await response.json();

                    if (result.success) {
                        // 商品更新成功
                        console.log('商品更新成功，ID:', result.product.id);
                        console.log('商品详情:', result.product);

                        alert('商品更新成功！');

                        // 隐藏表单并重置
                        const addProductForm = document.getElementById('addProductForm');
                        addProductForm.style.display = 'none';
                        document.getElementById('productForm').reset();
                        resetImagePreview();

                        // 重新加载商家商品列表
                        window.fetchMerchantProducts();
                    } else {
                        alert('更新商品失败：' + result.message);
                    }
                } catch (error) {
                    console.error('更新商品出错:', error);
                    alert('更新商品失败，请稍后重试');
                }
            }

            // 获取商家商品列表
            async function fetchMerchantProducts(page = 1) {
                try {
                    // 获取当前登录的商家用户名
                    // 从 localStorage 中获取用户名
                    const merchantName = localStorage.getItem('merchantName');
                    if (!merchantName) {
                        console.error('未找到商家用户名，请先登录');
                        alert('请先登录');
                        window.location.href = 'merchant-login.html';
                        return;
                    }
                    console.log('当前页面的账户名:', merchantName);

                    console.log(`正在获取商家 ${merchantName} 的商品列表`);

                    // 使用商家记录API获取商家的商品
                    const response = await fetch(`http://localhost:8080/api/merchant-records/user/${merchantName}?page=${page}&size=10`);

                    if (!response.ok) {
                        throw new Error('获取商家商品列表失败');
                    }

                    const data = await response.json();
                    console.log('获取到的商家商品数据:', data);

                    console.log('返回数据详情:', JSON.stringify(data));
                    console.log('记录数组:', data.records);
                    console.log('总记录数:', data.totalItems);

                    if (data.success) {
                        // 如果有商品记录，则获取对应的商品详情
                        if (data.records && data.records.length > 0) {
                            console.log('有商品记录，渲染商品列表');
                            // 已经包含商品信息，直接渲染
                            renderMerchantProducts(data.records, data.totalPages, page);
                        } else {
                            console.log('没有商品记录，显示空状态');
                            // 没有商品记录
                            renderEmptyProducts();
                        }
                    } else {
                        alert('获取商家商品列表失败：' + data.message);
                    }
                } catch (error) {
                    console.error('获取商家商品列表出错:', error);
                    alert('获取商家商品列表失败，请稍后重试');
                }
            }

            // 渲染空商品列表
            function renderEmptyProducts() {
                const tableBody = document.getElementById('productsTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 20px;">您还没有上传商品，请点击“添加商品”按钮添加商品</td>
                    </tr>
                `;

                // 清空分页
                document.getElementById('pagination').innerHTML = '';
            }

            // 渲染商家商品列表
            function renderMerchantProducts(records, totalPages, currentPage) {
                console.log('开始渲染商家商品列表:', records);

                const tableBody = document.getElementById('productsTableBody');
                tableBody.innerHTML = '';

                if (!records || records.length === 0) {
                    console.log('记录为空，显示空状态');
                    renderEmptyProducts();
                    return;
                }

                console.log(`开始渲染 ${records.length} 条商品记录`);

                records.forEach(record => {
                    // 使用商品信息
                    const product = {
                        id: record.productId,
                        productName: record.productName || '未知商品',
                        imagePath: record.productImagePath || '',
                        nowPrice: record.productPrice || 0,
                        originalPrice: record.productPrice ? record.productPrice * 1.2 : 0, // 模拟原价
                        category: record.category || '-',
                        salesCount: record.salesCount || 0,
                        status: record.status || '在售',
                        createTime: record.createTime || new Date().toISOString()
                    };

                    const statusClass = product.status === '在售' ? 'status-active' : 'status-inactive';
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td><img src="/templates/${product.imagePath}" alt="${product.productName}" class="product-image"></td>
                        <td>${product.productName}</td>
                        <td>¥${product.nowPrice} <del style="color: #999; font-size: 12px;">¥${product.originalPrice.toFixed(2)}</del></td>
                        <td>${product.category}</td>
                        <td>${product.salesCount}</td>
                        <td><span class="${statusClass} status-badge">${product.status}</span></td>
                        <td>${new Date(product.createTime).toLocaleString()}</td>
                        <td>
                            <div class="product-actions">
                                <div class="action-icon view-icon" title="查看" onclick="viewProduct(${product.id})">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="action-icon edit-icon" title="编辑" onclick="editProduct(${product.id})">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="action-icon delete-icon" title="删除" onclick="deleteProduct(${product.id})">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </div>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });

                // 渲染分页
                renderPagination(totalPages, currentPage);
            }

            // 渲染商品列表（兼容原有代码）
            function renderProducts(products) {
                const tableBody = document.getElementById('productsTableBody');
                tableBody.innerHTML = '';

                if (!products || products.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 20px;">暂无商品数据</td>
                        </tr>
                    `;
                    return;
                }

                products.forEach(product => {
                    const statusClass = product.status === '在售' ? 'status-active' : 'status-inactive';
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td><img src="${product.imagePath}" alt="${product.productName}" class="product-image"></td>
                        <td>${product.productName}</td>
                        <td>¥${product.nowPrice} <del style="color: #999; font-size: 12px;">¥${product.originalPrice}</del></td>
                        <td>${product.category || '-'}</td>
                        <td>${product.salesCount}</td>
                        <td><span class="${statusClass} status-badge">${product.status}</span></td>
                        <td>${new Date(product.createTime).toLocaleString()}</td>
                        <td>
                            <div class="product-actions">
                                <div class="action-icon view-icon" title="查看" onclick="viewProduct(${product.id})">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="action-icon edit-icon" title="编辑" onclick="editProduct(${product.id})">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="action-icon delete-icon" title="删除" onclick="deleteProduct(${product.id})">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </div>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });
            }

            // 渲染分页
            function renderPagination(totalPages, currentPage) {
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';

                if (totalPages <= 1) {
                    return;
                }

                // 上一页按钮
                if (currentPage > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'pagination-btn';
                    prevBtn.textContent = '上一页';
                    prevBtn.addEventListener('click', () => fetchProducts(currentPage - 1));
                    pagination.appendChild(prevBtn);
                }

                // 页码按钮
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => fetchProducts(i));
                    pagination.appendChild(pageBtn);
                }

                // 下一页按钮
                if (currentPage < totalPages) {
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'pagination-btn';
                    nextBtn.textContent = '下一页';
                    nextBtn.addEventListener('click', () => fetchProducts(currentPage + 1));
                    pagination.appendChild(nextBtn);
                }
            }

            // 声明全局函数，确保在任何地方都可以调用
            window.fetchMerchantProducts = fetchMerchantProducts;

            // 初始加载商家商品列表
            fetchMerchantProducts();
        });

        // 查看商品详情
        function viewProduct(productId) {
            window.open(`product-detail.html?id=${productId}`, '_blank');
        }

        // 更新商品的提交函数
        async function updateProductSubmit(event) {
            event.preventDefault();

            // 验证表单
            if (!validateForm()) {
                return;
            }

            // 获取商品ID
            const productId = document.getElementById('productId').value;

            // 获取表单数据
            const formData = new FormData();
            formData.append('productName', document.getElementById('productName').value);
            formData.append('productDesc', document.getElementById('productDesc').value);
            formData.append('nowPrice', document.getElementById('nowPrice').value);
            formData.append('originalPrice', document.getElementById('originalPrice').value);
            formData.append('brand', document.getElementById('brand').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('status', document.getElementById('status').value);
            formData.append('shippingAddress', document.getElementById('shippingAddress').value);

            // 如果选择了新图片，则添加到表单数据中
            const productImage = document.getElementById('productImage');
            if (productImage.files.length > 0) {
                formData.append('image', productImage.files[0]);
            }

            try {
                // 发送请求
                const response = await fetch(`http://localhost:8080/api/products/${productId}`, {
                    method: 'PUT',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('更新商品失败');
                }

                const result = await response.json();

                if (result.success) {
                    // 商品更新成功
                    console.log('商品更新成功，ID:', result.product.id);
                    console.log('商品详情:', result.product);

                    alert('商品更新成功！');

                    // 隐藏表单并重置
                    const addProductForm = document.getElementById('addProductForm');
                    addProductForm.style.display = 'none';
                    document.getElementById('productForm').reset();

                    // 直接重置图片预览，而不是调用resetImagePreview函数
                    const imagePreview = document.getElementById('imagePreview');
                    imagePreview.innerHTML = `
                        <div class="image-preview-placeholder">
                            <i class="fas fa-image"></i>
                            <p>选择图片预览</p>
                        </div>
                    `;

                    // 重新加载商家商品列表
                    window.fetchMerchantProducts();
                } else {
                    alert('更新商品失败：' + result.message);
                }
            } catch (error) {
                console.error('更新商品出错:', error);
                alert('更新商品失败，请稍后重试');
            }
        }

        // 编辑商品
        async function editProduct(productId) {
            try {
                // 获取商品详情
                const response = await fetch(`http://localhost:8080/api/products/${productId}`);
                const data = await response.json();

                if (!data.success) {
                    alert('获取商品详情失败: ' + data.message);
                    return;
                }

                const product = data.product;
                console.log('获取到商品详情:', product);

                // 填充表单
                document.getElementById('productName').value = product.productName || '';
                document.getElementById('productDesc').value = product.productDesc || '';
                document.getElementById('nowPrice').value = product.nowPrice || '';
                document.getElementById('originalPrice').value = product.originalPrice || '';
                document.getElementById('brand').value = product.brand || '';
                document.getElementById('category').value = product.category || '';
                document.getElementById('status').value = product.status || '在售';
                document.getElementById('shippingAddress').value = product.shippingAddress || '';

                // 显示当前图片
                if (product.imagePath) {
                    const imagePreview = document.getElementById('imagePreview');
                    imagePreview.innerHTML = `<img src="/templates/${product.imagePath}" alt="商品图片预览">`;
                }

                // 显示表单并修改标题
                const addProductForm = document.getElementById('addProductForm');
                addProductForm.style.display = 'block';
                document.querySelector('.form-title').textContent = '编辑商品';

                // 更新图片标签和提示
                document.getElementById('imageLabel').innerHTML = '商品图片';
                document.getElementById('imageHelp').textContent = '可选。如果不选择新图片，将保留原有图片。';

                // 更新按钮文本
                const submitButton = document.querySelector('button[type="submit"]');
                submitButton.textContent = '更新商品';

                // 修改表单提交逻辑
                const productForm = document.getElementById('productForm');

                // 移除旧的事件监听器
                const oldForm = productForm.cloneNode(true);
                productForm.parentNode.replaceChild(oldForm, productForm);

                // 添加商品ID的隐藏字段
                const productIdInput = document.createElement('input');
                productIdInput.type = 'hidden';
                productIdInput.id = 'productId';
                productIdInput.name = 'productId';
                productIdInput.value = productId;
                oldForm.appendChild(productIdInput);

                // 添加新的事件监听器
                oldForm.addEventListener('submit', updateProductSubmit);

                // 更新取消按钮的事件
                document.getElementById('cancelAddProduct').addEventListener('click', function() {
                    addProductForm.style.display = 'none';
                    document.querySelector('.form-title').textContent = '添加新商品';
                    oldForm.reset();
                    resetImagePreview();

                    // 恢复表单提交逻辑
                    oldForm.removeEventListener('submit', updateProductSubmit);
                    oldForm.addEventListener('submit', addProductSubmit);
                });
            } catch (error) {
                console.error('获取商品详情出错:', error);
                alert('获取商品详情失败，请稍后重试');
            }
        }

        // 删除商品
        async function deleteProduct(productId) {
            if (confirm(`确定要删除 ID 为 ${productId} 的商品吗？此操作不可撤销。`)) {
                try {
                    // 从 localStorage 中获取用户名
                    const merchantName = localStorage.getItem('merchantName');
                    if (!merchantName) {
                        console.error('未找到商家用户名，请先登录');
                        alert('请先登录');
                        window.location.href = 'merchant-login.html';
                        return;
                    }
                    console.log('当前页面的账户名:', merchantName);

                    // 显示删除中的提示
                    const loadingMessage = '正在删除商品，请稍候...';
                    console.log(loadingMessage);

                    try {
                        // 先检查商家记录
                        const checkResponse = await fetch(`http://localhost:8080/api/merchant-records/check?userName=${merchantName}&productId=${productId}`);
                        const checkResult = await checkResponse.json();

                        if (checkResult.success && checkResult.hasRecord) {
                            // 如果有商家记录，先删除记录
                            console.log(`删除商家 ${merchantName} 的商品 ${productId} 记录`);

                            try {
                                // 删除商家记录
                                const deleteRecordResponse = await fetch(`http://localhost:8080/api/merchant-records/delete-by-user-product?userName=${merchantName}&productId=${productId}`, {
                                    method: 'DELETE'
                                });

                                const deleteRecordResult = await deleteRecordResponse.json();
                                console.log('删除商家记录结果:', deleteRecordResult);

                                if (!deleteRecordResult.success) {
                                    console.warn('删除商家记录失败，但将继续删除商品');
                                }
                            } catch (recordError) {
                                console.error('删除商家记录出错:', recordError);
                                console.warn('将继续删除商品');
                            }
                        }

                        // 然后删除商品
                        console.log(`开始删除商品 ID: ${productId}`);
                        const response = await fetch(`http://localhost:8080/api/products/${productId}`, {
                            method: 'DELETE'
                        });

                        const data = await response.json();
                        console.log('删除商品响应:', data);

                        if (data.success) {
                            console.log('商品删除成功');
                            alert('商品删除成功！');
                            // 重新加载商家商品列表
                            window.fetchMerchantProducts();
                        } else {
                            console.error('删除商品失败:', data.message);
                            alert('删除商品失败：' + data.message);
                        }
                    } catch (apiError) {
                        console.error('调用API出错:', apiError);
                        alert('删除商品失败，请稍后重试');
                    }
                } catch (error) {
                    console.error('删除商品过程中发生未预期错误:', error);
                    alert('删除商品失败，请稍后重试');
                }
            }
        }
    </script>
</body>
</html>
