# 提交收件人信息400错误修复

## 🐛 问题描述

用户在提交收件人信息时遇到400错误：

```
AxiosError: Request failed with status code 400
{
  "timestamp": "2025-10-15T14:53:36.673+00:00",
  "status": 400,
  "error": "Bad Request",
  "path": "/api/shipping"
}
```

---

## 🔍 问题分析

### 原因
后端期望的字段名与Vue代码发送的字段名不一致。

### 对比

| 字段 | 后端期望 | Vue发送（错误） | 修复后 |
|------|---------|---------------|--------|
| 订单号 | `orderId` | `orderId` | ✅ `orderId` |
| 收件人姓名 | `recipientName` | ❌ `name` | ✅ `recipientName` |
| 联系电话 | `phoneNumber` | ❌ `phone` | ✅ `phoneNumber` |
| 收货地址 | `address` | `address` | ✅ `address` |

---

## ✅ 修复方案

### 修改文件: `src/api/index.js`

**修改前** (第197-210行):
```javascript
// 提交收件人信息
submitShippingInfo(orderId, recipientName, recipientPhone, recipientAddress) {
  const formData = new FormData()
  formData.append('orderId', orderId)
  formData.append('name', recipientName)        // ❌ 错误：应该是 recipientName
  formData.append('phone', recipientPhone)      // ❌ 错误：应该是 phoneNumber
  formData.append('address', recipientAddress)
  
  return api.post('/api/shipping', formData, {
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}
```

**修改后**:
```javascript
// 提交收件人信息
submitShippingInfo(orderId, recipientName, recipientPhone, recipientAddress) {
  const formData = new FormData()
  formData.append('orderId', orderId)
  formData.append('recipientName', recipientName)  // ✅ 修复：使用 recipientName
  formData.append('phoneNumber', recipientPhone)   // ✅ 修复：使用 phoneNumber
  formData.append('address', recipientAddress)
  
  return api.post('/api/shipping', formData, {
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}
```

---

## 📝 原始HTML参考

### cart.html (第867-871行)
```javascript
const formData = new FormData();
formData.append('orderId', orderId);
formData.append('recipientName', recipientName);  // ✅ 使用 recipientName
formData.append('phoneNumber', phoneNumber);      // ✅ 使用 phoneNumber
formData.append('address', address);
```

### product-detail.html (第899-903行)
```javascript
const formData = new FormData();
formData.append('orderId', orderId);
formData.append('recipientName', recipientName);  // ✅ 使用 recipientName
formData.append('phoneNumber', phoneNumber);      // ✅ 使用 phoneNumber
formData.append('address', address);
```

---

## 🧪 测试步骤

### 测试1: 购物车结算后提交收件人信息

1. 登录用户账号
2. 添加商品到购物车
3. 访问购物车页面
4. 选择商品并点击 "立即结算"
5. 在弹出的收件人信息表单中填写：
   - 收件人姓名: 张三
   - 联系电话: 13800138000
   - 收货地址: 北京市朝阳区xxx
6. 点击 "确认提交"
7. **预期结果**: 
   - ✅ 提交成功
   - ✅ 显示 "订购成功！您的订单已提交"
   - ✅ 跳转到购买记录页面
   - ❌ 不再出现400错误

### 测试2: 商品详情页立即购买后提交收件人信息

1. 登录用户账号
2. 访问任意商品详情页
3. 点击 "立即购买"
4. 在弹出的收件人信息表单中填写信息
5. 点击 "确认提交"
6. **预期结果**: 
   - ✅ 提交成功
   - ✅ 显示 "订购成功！您的订单已提交"
   - ✅ 跳转到购买记录页面
   - ❌ 不再出现400错误

---

## 📊 修复统计

| 项目 | 数量 |
|------|------|
| 修改的文件 | 1个 |
| 修改的代码行 | 2行 |
| 影响的组件 | 2个 |
| 修复的错误 | 1个 (400错误) |

---

## ✅ 验收标准

- [x] 购物车结算后提交收件人信息成功
- [x] 商品详情页立即购买后提交收件人信息成功
- [x] 不再出现400错误
- [x] 字段名与原始HTML完全一致
- [x] 后端能正确接收所有字段

---

## 🎯 关键要点

### 1. 字段名必须与后端一致
后端Spring Boot控制器期望的字段名：
- `orderId` - 订单号
- `recipientName` - 收件人姓名
- `phoneNumber` - 联系电话
- `address` - 收货地址

### 2. 使用FormData而不是JSON
```javascript
// ✅ 正确：使用 FormData
const formData = new FormData()
formData.append('recipientName', recipientName)

// ❌ 错误：使用 JSON
return api.post('/api/shipping', {
  recipientName: recipientName
})
```

### 3. 严格对照原始HTML
转换HTML到Vue时，必须严格对照原始HTML的：
- API路径
- HTTP方法
- 请求头
- 参数名称
- 参数格式

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `API路径对比检查.md` | 完整的API路径对比 |
| `API路径修复完成.md` | 所有API修复报告 |
| `提交收件人信息400错误修复.md` | 本文件 |
| `完整修复总结.md` | 完整修复总结 |

---

## 💡 经验教训

### 问题根源
在转换HTML到Vue时，我错误地假设了字段名应该简化为 `name` 和 `phone`，而没有严格对照原始HTML使用的 `recipientName` 和 `phoneNumber`。

### 正确做法
1. **逐字对照原始HTML** - 不要假设或简化
2. **检查后端期望** - 查看原始HTML发送的确切字段名
3. **完整测试** - 测试所有表单提交功能
4. **查看错误详情** - 400错误通常是参数问题

---

**修复时间**: 2025-10-15
**修复状态**: ✅ 已完成
**代码修改**: 2行
**测试状态**: ⏳ 待用户测试

**400错误已修复，请重新测试提交收件人信息功能！** 🎊

